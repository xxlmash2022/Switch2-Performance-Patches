<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Switch 2 â€“ Performance Patches & Neue Spiele</title>
  <meta name="color-scheme" content="dark light">
  <style>
    :root { --bg:#0b0e11; --card:#12161c; --text:#e6edf3; --muted:#9aa7b2; --accent:#26c281; --table:#1f2630; }
    html,body{ background:var(--bg); color:var(--text); font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Arial; margin:0; }

    /* Hero-Banner */
    .hero-wrap{ position:relative; }
    .hero{ width:100%; height:240px; object-fit:cover; display:block; border-bottom:1px solid var(--table); background:#0b0e11; }
    .hero-tag{ position:absolute; right:16px; bottom:12px; background:rgba(0,0,0,.5); border:1px solid var(--table); color:var(--muted);
               padding:6px 10px; border-radius:10px; font-size:.9rem; backdrop-filter: blur(2px); }
    @media (min-width: 900px){ .hero{ height:320px; } }

    /* Tabs */
    .tabs{ display:flex; gap:8px; padding:12px 20px; flex-wrap:wrap; }
    .tab-btn{ background:var(--card); border:1px solid var(--table); color:var(--text); padding:8px 12px; border-radius:999px; cursor:pointer; font-weight:600; }
    .tab-btn[aria-selected="true"]{ outline:2px solid var(--accent); }

    .wrap{ padding:0 20px 28px; }
    .table-card{ background:var(--card); border:1px solid var(--table); border-radius:14px; overflow:hidden; box-shadow:0 10px 30px rgba(0,0,0,.35); }
    table{ width:100%; border-collapse:collapse; }
    thead th{ text-align:left; padding:14px 12px; font-size:.92rem; color:var(--muted); border-bottom:1px solid var(--table); font-weight:600; }
    tbody td{ padding:10px 12px; border-bottom:1px solid var(--table); vertical-align:middle; }
    tbody tr:hover{ background:rgba(255,255,255,.02); }
    .thumb{ width:270px; height:153px; border-radius:8px; object-fit:cover; display:block; border:1px solid #222b36; }
    .game a{ color:var(--text); text-decoration:none; font-weight:600; } .game a:hover{ text-decoration:underline; }
    .kernCell{ color:var(--text); }
    .source a{ color:var(--muted); text-decoration:none; } .source a:hover{ text-decoration:underline; }
    .hidden{ display:none; }
    .foot{ color:var(--muted); font-size:.9rem; margin-top:14px; line-height:1.5; }
    .price{ white-space:nowrap; font-weight:600; }

    /* Debug */
    #debug-panel{ margin:16px 20px; background:#0f1318; border:1px solid #1f2630; border-radius:10px; }
    #debug-panel>summary{ cursor:pointer; padding:10px 12px; font-weight:700 }
    #dbg-meta{ display:flex; gap:18px; flex-wrap:wrap; padding:0 12px 10px; color:#9aa7b2 }
    #dbg-log{ max-height:260px; overflow:auto; background:#0b0e11; margin:0 12px 12px; padding:10px; border:1px dashed #26303b; border-radius:8px;
              font:12px/1.45 ui-monospace,SFMono-Regular,Menlo,Consolas,monospace; color:#e6edf3 }
    .dbg-ok{ color:#26c281 } .dbg-warn{ color:#ffcc66 } .dbg-err{ color:#ff6b6b }

    /* ===== Mobile-Optimierung (unter 768px) ===== */
    @media (max-width: 768px){
      .tabs{ position:sticky; top:0; z-index:20; background:linear-gradient(to bottom, rgba(11,14,17,.98), rgba(11,14,17,.92)); padding:10px 12px; }
      .wrap{ padding:0 12px 24px; }

      /* Tabellen â†’ Kartenlayout */
      table, thead, tbody, th, td, tr { display:block; }
      thead{ position:absolute; left:-9999px; }
      tbody tr{ margin:12px 0; padding:12px; border:1px solid var(--table); border-radius:14px; background:var(--card); }
      tbody td{ border:none; padding:6px 0; }
      tbody td::before{
        content: attr(data-label);
        display:block; color:var(--muted); font-size:.85rem; margin-bottom:2px;
      }

      /* Thumbnail vollbreit, 16:9 */
      .thumb{ width:100%; height:auto; aspect-ratio:16/9; }

      /* SpaltenabstÃ¤nde etwas enger */
      .kernCell{ margin-top:6px; }
      .price{ margin-top:6px; }
    }

    /* ===== Mobile: ZurÃ¼ck-nach-oben-Button ===== */
    #toTop{
      position: fixed; right:16px; bottom:16px;
      background:var(--accent); color:#0a0f14; border:none;
      padding:12px 14px; border-radius:999px; font-weight:800; cursor:pointer;
      box-shadow:0 8px 24px rgba(0,0,0,.35);
      opacity:0; pointer-events:none; transition:opacity .2s ease, transform .2s ease;
      transform: translateY(8px); z-index:50;
    }
    #toTop.show{ opacity:1; pointer-events:auto; transform: translateY(0); }
    /* Desktop: nie anzeigen */
    @media (min-width: 769px){ #toTop{ display:none !important; } }
  </style>
</head>
<body>
  <!-- Hero-Banner -->
  <div class="hero-wrap">
    <img id="hero" class="hero"
         alt="Nintendo Switch 2 â€“ Spiele & Performance-Patches"
         data-src1="assets/switch2-banner.png"
         data-src2="assets/switch2-banner.jpg"
         data-src3="assets/banner-fallback.svg">
    <div class="hero-tag">Stand: <time id="today"></time></div>
  </div>

  <!-- Tabs (mit dynamischer Anzahl in Klammern) -->
  <nav class="tabs" role="tablist" aria-label="Listenwahl">
    <button class="tab-btn" role="tab" id="tab-perf" data-base="Performance-Patches" aria-selected="true" aria-controls="panel-perf">Performance-Patches (0)</button>
    <button class="tab-btn" role="tab" id="tab-new"  data-base="Neue Switch 2 Spiele" aria-selected="false" aria-controls="panel-new">Neue Switch 2 Spiele (0)</button>
  </nav>

  <div class="wrap">
    <!-- Panel 1: Performance (JSON-basiert) -->
    <section id="panel-perf" class="table-card" role="tabpanel" aria-labelledby="tab-perf">
      <table id="games-perf">
        <thead>
          <tr><th>Thumbnail</th><th>Spiel (Nintendo DE bevorzugt)</th><th>Kern-Patch-Inhalte</th><th>Quelle</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>

    <!-- Panel 2: Neue Spiele (JSON + Preis in â‚¬) -->
    <section id="panel-new" class="table-card hidden" role="tabpanel" aria-labelledby="tab-new">
      <table id="games-new">
        <thead>
          <tr><th>Thumbnail</th><th>Spiel (Nintendo DE bevorzugt)</th><th>Preis (â‚¬)</th><th>Quelle</th></tr>
        </thead>
        <tbody></tbody>
      </table>
      <p class="foot" id="newCount"></p>
    </section>

    <p class="foot">
      Regeln: DE-Shoplinks bevorzugt; bei 404 â†’ US. Thumbnails: EU-H2x1 â†’ US-Hero â†’ Proxy â†’ Inline-SVG. GrÃ¶ÃŸen/Spalten bleiben stabil.
    </p>
  </div>

  <!-- Debug-Panel -->
  <details id="debug-panel"><summary>ðŸ”§ Debug</summary>
    <div id="dbg-meta">
      <div>Perf-JSON: <b id="dbg-perf">init</b></div>
      <div>New-JSON: <b id="dbg-new">init</b></div>
      <div>Perf Items: <b id="dbg-perf-items">0</b></div>
      <div>New Items: <b id="dbg-new-items">0</b></div>
      <div>Bildfehler: <b id="dbg-img-errors">0</b></div>
    </div>
    <pre id="dbg-log"></pre>
  </details>

  <!-- Mobile â€žZurÃ¼ck nach obenâ€œ -->
  <button id="toTop" aria-label="ZurÃ¼ck nach oben">â†‘</button>

  <script>
    // Datum & Hero laden
    try { document.getElementById('today').textContent = new Intl.DateTimeFormat('de-DE').format(new Date()); } catch(_){}
    (function initHero(){
      const img = document.getElementById('hero');
      const tries = [img.dataset.src1, img.dataset.src2, img.dataset.src3].filter(Boolean);
      let i = 0;
      function next(){ if(i>=tries.length){ return; } img.src = tries[i++]; }
      img.onerror = next;
      img.onload  = ()=>{ if(!img.naturalWidth) next(); };
      next();
    })();

    // Tabs
    const tabPerf = document.getElementById('tab-perf');
    const tabNew  = document.getElementById('tab-new');
    const panelPerf = document.getElementById('panel-perf');
    const panelNew  = document.getElementById('panel-new');
    function select(tab){ const isPerf = tab.id === 'tab-perf'; tabPerf.setAttribute('aria-selected', isPerf); tabNew.setAttribute('aria-selected', !isPerf); panelPerf.classList.toggle('hidden', !isPerf); panelNew.classList.toggle('hidden', isPerf); }
    tabPerf.addEventListener('click', () => select(tabPerf));
    tabNew .addEventListener('click', () => select(tabNew ));

    // Button-Count dynamisch setzen
    function setTabCount(btn, count){
      const base = btn.getAttribute('data-base') || btn.textContent.replace(/\s*\(\d+\)\s*$/,'').trim();
      btn.textContent = `${base} (${count})`;
      btn.setAttribute('aria-label', `${base} (${count})`);
    }

    // Debug helpers
    const dbg = {
      logEl: document.getElementById('dbg-log'),
      perfEl: document.getElementById('dbg-perf'),
      newEl:  document.getElementById('dbg-new'),
      perfItemsEl: document.getElementById('dbg-perf-items'),
      newItemsEl:  document.getElementById('dbg-new-items'),
      imgErrEl: document.getElementById('dbg-img-errors'),
      imgErrors: 0,
      log(msg, cls){ const span=document.createElement('span'); span.textContent = `[DBG] ${msg}\n`; if(cls) span.className=cls; dbg.logEl.appendChild(span); dbg.logEl.scrollTop=dbg.logEl.scrollHeight; }
    };

    // SVG-Fallback + Loader fÃ¼r Thumbs
    function svgData(title, reason){
      const svg = encodeURIComponent(`<svg xmlns='http://www.w3.org/2000/svg' width='270' height='153'><defs><linearGradient id='g' x1='0' x2='1' y1='0' y2='1'><stop offset='0' stop-color='#1b2a33'/><stop offset='1' stop-color='#0f1720'/></linearGradient></defs><rect width='100%' height='100%' fill='url(#g)'/><text x='16' y='84' font-family='system-ui,Segoe UI,Arial' font-size='20' fill='#e6edf3'>${title}</text><text x='16' y='120' font-family='system-ui,Segoe UI,Arial' font-size='12' fill='#9aa7b2'>${reason}</text></svg>`);
      return `data:image/svg+xml;charset=utf-8,${svg}`;
    }
    function prox(u){ return u ? ('https://images.weserv.nl/?url=' + encodeURIComponent(u.replace(/^https?:\/\//,''))) : ''; }
    function initThumb(img){
      const tryList = [img.dataset.src1, img.dataset.src2, img.dataset.src3, img.dataset.src4].filter(Boolean);
      let i = 0;
      function next(){ if(i>=tryList.length){ dbg.imgErrors++; dbg.imgErrEl.textContent = String(dbg.imgErrors); img.src = svgData(img.alt.replace('Thumbnail ','')||'Spiel','Kein Bild verfÃ¼gbar'); return; } img.src = tryList[i++]; }
      img.onerror = next; img.onload = ()=>{ if(!img.naturalWidth) next(); };
      next();
    }

    // Renderer (mit data-labels fÃ¼rs Mobile-Kartenlayout)
    function rowPerf(e){
      const link = e.de || e.us || '#';
      const label = e.de ? 'Nintendo DE' : (e.us ? 'Nintendo US' : 'Nintendo');
      const title = e.name || 'Unbekannt';
      const kern  = e.kern || 'â€”';
      const img1  = e.img || e.img2 || e.eu || '';
      const img2  = e.img2 || e.us_hero || '';
      return `<tr>
        <td data-label="Thumbnail"><a href="${link}" target="_blank" rel="noopener"><img class="thumb" alt="Thumbnail ${title}"
             data-src1="${img1}" data-src2="${img2}" data-src3="${prox(img1)}" data-src4="${prox(img2)}"></a></td>
        <td class="game" data-label="Spiel"><a href="${link}" target="_blank" rel="noopener">${title}</a></td>
        <td class="kernCell" data-label="Kern-Patch-Inhalte">${kern}</td>
        <td class="source" data-label="Quelle"><a href="${link}" target="_blank" rel="noopener">${label}</a></td>
      </tr>`;
    }
    function rowNew(e){
      const link = e.de || e.us || '#';
      const label = e.de ? 'Nintendo DE' : (e.us ? 'Nintendo US' : 'Nintendo');
      const title = e.name || 'Unbekannt';
      const img1  = e.img || e.img2 || '';
      const img2  = e.img2 || e.img  || '';
      const price = (typeof e.price_eur === 'number') ? new Intl.NumberFormat('de-DE', {style:'currency', currency:'EUR'}).format(e.price_eur) : 'â€”';
      return `<tr>
        <td data-label="Thumbnail"><a href="${link}" target="_blank" rel="noopener"><img class="thumb" alt="Thumbnail ${title}"
             data-src1="${img1}" data-src2="${img2}" data-src3="${prox(img1)}" data-src4="${prox(img2)}"></a></td>
        <td class="game" data-label="Spiel"><a href="${link}" target="_blank" rel="noopener">${title}</a></td>
        <td class="price" data-label="Preis (EUR)">${price}</td>
        <td class="source" data-label="Quelle"><a href="${link}" target="_blank" rel="noopener">${label}</a></td>
      </tr>`;
    }

    async function loadJSON(url, labelEl){
      try{
        const r = await fetch(url, {cache:'no-cache'});
        if(!r.ok) throw new Error('HTTP '+r.status);
        const data = await r.json();
        labelEl.textContent = 'ok'; labelEl.className = 'dbg-ok';
        return Array.isArray(data) ? data : [];
      }catch(e){
        dbg.log(`Fetch ${url} failed: ${e.message}`, 'dbg-err');
        labelEl.textContent = 'Fehler'; labelEl.className = 'dbg-err';
        return [];
      }
    }

    // Load Performance
    (async function(){
      const body = document.querySelector('#games-perf tbody');
      const list = await loadJSON('./performance_patches.json', dbg.perfEl);
      body.innerHTML = list.map(rowPerf).join('');
      body.querySelectorAll('img.thumb').forEach(initThumb);
      dbg.perfItemsEl.textContent = String(list.length);
      setTabCount(tabPerf, list.length);
    })();

    // Load Neue Spiele
    (async function(){
      const body = document.querySelector('#games-new tbody');
      const countEl = document.getElementById('newCount');
      const list = await loadJSON('./new_switch2_games.json', dbg.newEl);
      body.innerHTML = list.map(rowNew).join('');
      body.querySelectorAll('img.thumb').forEach(initThumb);
      dbg.newItemsEl.textContent = String(list.length);
      countEl.textContent = 'Anzahl: ' + list.length;
      setTabCount(tabNew, list.length);
    })();

    // Mobile: ZurÃ¼ck-nach-oben-Button Logik
    (function(){
      const btn = document.getElementById('toTop');
      let last = 0;
      function onScroll(){
        const y = window.scrollY || document.documentElement.scrollTop || 0;
        if (y > 180){ btn.classList.add('show'); } else { btn.classList.remove('show'); }
        last = y;
      }
      window.addEventListener('scroll', onScroll, { passive: true });
      onScroll();
      btn.addEventListener('click', () => {
        try{
          window.scrollTo({ top: 0, behavior: 'smooth' });
        }catch(_){
          document.documentElement.scrollTop = 0; document.body.scrollTop = 0;
        }
      });
    })();
  </script>
</body>
</html>